<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Gerenciador de Emuladores</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      
      .duplicacao-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        margin-bottom: 20px;
        animation: surgir 0.3s ease-in;
      }

      .celular {
        width: 40px;
        height: 70px;
        border: 2px solid #6c757d;
        border-radius: 10px;
        position: relative;
        background: linear-gradient(to bottom, #f8f9fa, #dee2e6);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.5s ease;
      }

      .celular::before {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: #6c757d;
        border-radius: 50%;
      }

      .seta {
        font-size: 1.5rem;
        animation: piscar 1s infinite;
        color: #6c757d;
      }

      .celular-direita {
        opacity: 0;
        transform: scale(0.8);
        animation: aparecer 1.5s forwards;
        animation-delay: 1s;
      }

      @keyframes piscar {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }

      @keyframes aparecer {
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes surgir {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      .overlay .animacao-celulares {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
      }

      .overlay h3 {
        font-size: 1.5rem;
        color: #444;
        margin-top: 30px;
      }

      .resultado-final {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.5s ease-in-out;
      }

      .resultado-final .icone {
        font-size: 4rem;
        margin-bottom: 10px;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to   { opacity: 1; transform: scale(1); }
      }
    </style>
  </head>
  <body class="container py-5">
    <h1 class="mb-4">Gerenciador de Emuladores</h1>

    <form id="formDuplicar" class="row g-3">
      <div class="col-md-4">
        <select name="avd_base" class="form-select" required>
          <option value="">Selecione o AVD base</option>
          {% for avd in avds %}
          <option value="{{ avd.nome }}">{{ avd.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <input
          name="avd_novo"
          class="form-control"
          placeholder="Nome do novo AVD"
          required
        />
      </div>
      <div class="col-md-2">
        <button id="btnDuplicar" type="submit" class="btn btn-secondary w-100">
          <span
            class="spinner-border spinner-border-sm d-none"
            id="spinnerDuplicar"
            role="status"
          ></span>
          <span id="labelBtnDuplicar">Duplicar</span>
        </button>
      </div>
    </form>

    <!-- Feedback visual de duplicação -->
    <div id="duplicacaoVisual" class="duplicacao-container d-none">
      <div class="celular celular-esquerda"></div>
      <div class="seta">&#10140;</div>
      <div class="celular celular-direita"></div>
    </div>

    <!-- Tela de bloqueio (overlay) -->
    <div id="overlay" class="overlay d-none">
      <div id="animacaoClonagem" class="animacao-celulares">
        <div class="celular celular-esquerda"></div>
        <div class="seta">&#10140;</div>
        <div class="celular celular-direita"></div>
      </div>

      <div id="resultadoClonagem" class="resultado-final">
        <div id="iconeResultado" class="icone">✔️</div>
        <h3 id="mensagemResultado">AVD duplicado com sucesso!</h3>
      </div>

      <h3 id="mensagemAguardando" class="mt-4">
        Não feche até terminar o processo de clonagem
      </h3>
    </div>

    <div id="alertaDuplicacao" class="mt-3"></div>

    <hr class="my-5" />
    <h3>Lista de AVDs</h3>

    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Porta</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for avd in avds %}
        <tr>
          <td>{{ avd.nome }}</td>
          <td>{{ avd.porta }}</td>
          <td>
            {% if avd.status == 'Rodando' %}
            <span class="badge bg-success">Rodando</span>
            {% else %}
            <span class="badge bg-secondary">Desligado</span>
            {% endif %}
          </td>
          <td>
            {% if avd.status == 'Rodando' %}
            <form action="{{ url_for('emuladores.parar_avd_route', porta=avd.porta) }}" method="post" class="d-inline">
              <button class="btn btn-sm btn-danger">Desligar</button>
            </form>
            {% else %}
            <form action="{{ url_for('emuladores.gerenciar_emuladores') }}" method="post" class="d-inline">
              <input type="hidden" name="acao" value="usar_existente" />
              <input type="hidden" name="avd_existente" value="{{ avd.nome }}" />
              <input type="hidden" name="porta_existente" value="{{ avd.porta }}" />
              <button class="btn btn-sm btn-success">Ligar</button>
            </form>
            {% endif %}
          <form action="{{ url_for('emuladores.deletar_avd_route', nome=avd.nome) }}" method="post" class="d-inline ms-2">
            <button class="btn btn-sm btn-outline-danger" {% if avd.status=='Rodando' %} disabled
              title="Desligue o AVD para excluí-lo" {% endif %}>
              Excluir
            </button>
          </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      const form = document.getElementById("formDuplicar");
      const spinner = document.getElementById("spinnerDuplicar");
      const btn = document.getElementById("btnDuplicar");
      const label = document.getElementById("labelBtnDuplicar");
      const alerta = document.getElementById("alertaDuplicacao");
      const duplicacaoVisual = document.getElementById("duplicacaoVisual");
      const overlay = document.getElementById("overlay");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        alerta.innerHTML = "";

        duplicacaoVisual.classList.remove("d-none");
        overlay.classList.remove("d-none");

        document.getElementById("resultadoClonagem").style.display = "none";
        document.getElementById("animacaoClonagem").style.display = "flex";
        document.getElementById("mensagemAguardando").style.display = "block";

        const formData = new FormData(form);
        spinner.classList.remove("d-none");
        label.textContent = "Aguarde...";
        btn.disabled = true;

        const res = await fetch(`/duplicar_avd`, {
          method: "POST",
          body: formData,
        });

        const json = await res.json();

        if (json.erro) {
          alerta.innerHTML = `<div class="alert alert-danger">${json.erro}</div>`;
          spinner.classList.add("d-none");
          btn.disabled = false;
          label.textContent = "Duplicar";
          duplicacaoVisual.classList.add("d-none");
          overlay.classList.add("d-none");
          return;
        }

        const { task_id } = json;

        const interval = setInterval(async () => {
          const r = await fetch(`/status/${task_id}`);
          const { status, erro } = await r.json();

          if (erro || status === "concluido") {
            clearInterval(interval);
            spinner.classList.add("d-none");
            btn.disabled = false;
            label.textContent = "Duplicar";

            document.getElementById("animacaoClonagem").style.display = "none";
            document.getElementById("mensagemAguardando").style.display = "none";
            document.getElementById("resultadoClonagem").style.display = "flex";

            const icone = document.getElementById("iconeResultado");
            const mensagem = document.getElementById("mensagemResultado");

            if (erro) {
              alerta.innerHTML = `<div class="alert alert-danger">${erro}</div>`;
              icone.textContent = "❌";
              mensagem.textContent = "Erro ao duplicar o AVD";
              overlay.classList.add("d-none");
              return;
            }

            icone.textContent = "✔️";
            mensagem.textContent = "AVD duplicado com sucesso!";

            setTimeout(() => location.reload(), 1500);
          }
        }, 1000);
      });
    </script>
  </body>
</html>
