<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Gerenciador de Emuladores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container py-4">
    <header class="mb-4">
      <h1 class="h3">Gerenciador de Emuladores</h1>
      <div
        id="startBusyBanner"
        class="alert alert-info d-none mt-3"
        role="alert"
      >
        <span
          class="spinner-border spinner-border-sm me-2"
          role="status"
          aria-hidden="true"
        ></span>
        Processando inicializa√ß√£o... aguarde.
      </div>
    </header>

    {% with msgs = get_flashed_messages(with_categories=true) %} {% if msgs %}
    <div class="mb-3">
      {% for category, message in msgs %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        {{ message|safe }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Fechar"
        ></button>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- (Opcional) Duplicar AVD: s√≥ aparece se quiser usar a fun√ß√£o -->
    <section class="card mb-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Duplicar AVD</h2>
        <form id="formDuplicar" class="row g-2">
          <div class="col-md-4">
            <input
              class="form-control form-control-sm"
              name="avd_base"
              placeholder="Nome AVD base"
              required
            />
          </div>
          <div class="col-md-4">
            <input
              class="form-control form-control-sm"
              name="avd_novo"
              placeholder="Novo nome"
              required
            />
          </div>
          <div class="col-md-2 d-grid">
            <button
              id="btnDuplicar"
              type="submit"
              class="btn btn-sm btn-secondary"
            >
              <span
                id="spinnerDuplicar"
                class="spinner-border spinner-border-sm me-1 d-none"
              ></span>
              <span id="labelBtnDuplicar">Duplicar</span>
            </button>
          </div>
          <div class="col-12" id="alertaDuplicacao"></div>
        </form>
      </div>
    </section>

    <!-- Lista de AVDs -->
    <section class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h6 m-0">AVDs</h2>
          <div class="d-flex gap-2">
            <form
              action="{{ url_for('emuladores.ligar_todos') }}"
              method="post"
              class="m-0"
            >
              <button
                type="submit"
                class="btn btn-sm btn-outline-primary btn-ligar-all"
              >
                <span
                  class="spinner-border spinner-border-sm me-1 d-none"
                ></span>
                Ligar todos
              </button>
            </form>
            <form
              action="{{ url_for('emuladores.desligar_todos') }}"
              method="post"
              class="m-0 form-desligar-todos"
            >
              <button type="submit" class="btn btn-sm btn-outline-danger">
                Desligar todos
              </button>
            </form>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Porta</th>
                <th>Status</th>
                <th class="text-end">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for avd in avds %}
              <tr>
                <td>{{ avd.nome }}</td>
                <td>{{ avd.porta }}</td>
                <td>
                  {% if avd.status == 'Rodando' %}
                  <span class="badge bg-success">Rodando</span>
                  {% else %}
                  <span class="badge bg-secondary">Desligado</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if avd.status == 'Rodando' %}
                  <form
                    action="{{ url_for('emuladores.parar_avd_route', porta=avd.porta) }}"
                    method="post"
                    class="d-inline form-desligar"
                  >
                    <button class="btn btn-sm btn-danger">Desligar</button>
                  </form>
                  {% else %}
                  <form
                    action="{{ url_for('emuladores.gerenciar_emuladores') }}"
                    method="post"
                    class="d-inline form-ligar"
                  >
                    <input type="hidden" name="acao" value="usar_existente" />
                    <input
                      type="hidden"
                      name="avd_existente"
                      value="{{ avd.nome }}"
                    />
                    <input
                      type="hidden"
                      name="porta_existente"
                      value="{{ avd.porta }}"
                    />
                    <button class="btn btn-sm btn-success btn-ligar">
                      <span
                        class="spinner-border spinner-border-sm me-1 d-none"
                      ></span>
                      Ligar
                    </button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Rob√¥ de Sess√£o -->
    <section class="card mt-4">
      <div class="card-body">
        <h2 class="h6 mb-3">Rob√¥ para Procurar Hor√°rio</h2>
        <form id="formSessionBot" class="row g-2">
          <div class="col-2">
            <input
              name="porta"
              class="form-control form-control-sm"
              placeholder="Porta"
              required
            />
          </div>
          <div class="col-4">
            <input
              name="texto_alvo"
              class="form-control form-control-sm"
              placeholder="Texto do hor√°rio (ex: 15:30)"
              required
            />
          </div>
          <div class="col-3">
            <input
              name="intervalo"
              type="number"
              step="0.1"
              value="3"
              class="form-control form-control-sm"
              placeholder="Intervalo (seg)"
            />
          </div>
          <div class="col-2 d-grid">
            <button class="btn btn-sm btn-success">üîç Iniciar Busca</button>
          </div>
          <div class="col-1 d-flex align-items-center">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="chkNotifyWpp"
              />
              <label
                class="form-check-label small"
                for="chkNotifyWpp"
                title="Notificar via WhatsApp quando encontrar"
                >üì±</label
              >
            </div>
          </div>
        </form>

        <!-- Bot√µes de Controle -->
        <div class="mt-3 d-flex gap-2">
          <button id="btnPause" class="btn btn-sm btn-warning">
            ‚è∏Ô∏è Pausar/Retomar
          </button>
          <button id="btnStop" class="btn btn-sm btn-danger">‚èπÔ∏è Parar</button>
          <button id="btnStatus" class="btn btn-sm btn-outline-secondary">
            üìä Status
          </button>
        </div>

        <!-- Log de Atividades -->
        <div class="mt-3">
          <label class="form-label small">Log de Atividades:</label>
          <pre
            id="sessionBotLog"
            class="small border rounded p-2 bg-light"
            style="max-height: 200px; overflow: auto"
          >
Aguardando in√≠cio...</pre
          >
        </div>
      </div>
    </section>

    <!-- (Opcional) Modal duplica√ß√£o -->
    <div
      class="modal fade"
      id="modalDuplicacao"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Duplicando AVD...</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            <div class="d-flex gap-3 align-items-center">
              <div class="spinner-border text-secondary"></div>
              <div>
                <div id="statusDuplicacao" class="fw-semibold">
                  Iniciando...
                </div>
                <small class="text-muted">Aguarde finalizar.</small>
              </div>
            </div>
            <div id="resultadoDuplicacao" class="mt-3 d-none"></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/emuladores.js') }}"></script>
  </body>
</html>
